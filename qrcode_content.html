<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ä¸‹è½½App</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: #f6f8fa;
      margin: 0; padding: 30px;
      display: flex; flex-direction: column; align-items: center;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 4px;
    }
    #hint {
      color: #666;
      margin-bottom: 20px;
    }

    /* ä¸»æ˜¾ç¤ºåŒºåŸŸ */
    #result {
      margin-top: 10px;
      width: 90%;
      max-width: 600px;
      min-height: 40px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 18px 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #333;
      transition: all 0.2s;
      overflow-wrap: break-word;
      word-break: break-all;
    }
    #result.has-content {
      color: #000;
      min-height: 60px;
    }

    #result .content {
      flex: 1;
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
    }

    button {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      background: #0078d4;
      color: white;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: background 0.2s, transform 0.1s;
    }
    button:hover {
      background: #005fa3;
      transform: translateY(-1px);
    }

    /* å±é™©æ“ä½œæŒ‰é’®ï¼ˆæ¸…é™¤ï¼‰ */
    .btn-danger {
      background: #d9534f;
    }
    .btn-danger:hover {
      background: #c9302c;
      transform: translateY(-1px);
    }

    /* å†å²è®°å½• */
    .history {
      margin-top: 30px;
      width: 90%;
      max-width: 600px;
    }
    .history h3 {
      color: #444;
      margin-bottom: 10px;
    }
    .item {
      background: white;
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      overflow-wrap: break-word;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .item .title {
      font-weight: bold;
      margin-bottom: 4px;
      color: #222;
    }
    .item .content {
      max-height: 200px;
      overflow-y: auto;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .item .buttons {
      justify-content: flex-end;
      margin-top: 6px;
    }

    /* toastæç¤º */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ å‰ªè´´æ¿äºŒç»´ç è§£æ</h1>
  <div id="hint">å¤åˆ¶äºŒç»´ç å›¾ç‰‡åï¼Œç›´æ¥æŒ‰ <b>Ctrl+V</b> æˆ– <b>âŒ˜+V</b> ç²˜è´´å³å¯è§£æ</div>

  <div id="result">æš‚æ— è§£æç»“æœ</div>

  <div class="history">
    <div class="history-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h3>å†å²è®°å½•</h3>
      <button id="clearHistoryBtn" class="btn-danger" onclick="clearHistory()">æ¸…é™¤å†å²</button>
    </div>
    <div id="historyList"></div>
  </div>

  <div id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <script>
    const resultDiv = document.getElementById('result');
    const historyList = document.getElementById('historyList');
    const toast = document.getElementById('toast');

    document.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const blob = item.getAsFile();
          const img = await blobToImage(blob);
          const qrContent = decodeQRFromImage(img);
          if (qrContent) {
            showResult(String(qrContent));
            saveHistory(String(qrContent));
            renderHistory();
          } else {
            showResult(null);
            alert('æœªæ£€æµ‹åˆ°äºŒç»´ç ï¼Œè¯·ç¡®è®¤ç²˜è´´çš„å›¾ç‰‡ä¸ºäºŒç»´ç ã€‚');
          }
          return;
        }
      }
      alert('å‰ªè´´æ¿ä¸­æ²¡æœ‰æ£€æµ‹åˆ°å›¾ç‰‡ï¼Œè¯·å¤åˆ¶äºŒç»´ç å›¾ç‰‡åç²˜è´´ã€‚');
    });

    function blobToImage(blob) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(blob);
      });
    }

    function decodeQRFromImage(img) {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      return code && code.data ? code.data : null;
    }

    function showResult(text) {
      if (!text) {
        resultDiv.classList.remove('has-content');
        resultDiv.innerHTML = 'æš‚æ— è§£æç»“æœ';
        return;
      }
      resultDiv.classList.add('has-content');
      const safeText = escapeHtml(text);
      const isLink = /^https?:\/\//i.test(text);
      resultDiv.innerHTML = `
        <div class="content">${safeText}</div>
        <div class="buttons">
          <button onclick="copyText(\`${safeText}\`)">å¤åˆ¶</button>
          ${isLink ? `<button onclick="window.open(encodeURI('${text}'),'_blank')">æ‰“å¼€</button>` : ''}
        </div>
      `;
    }

    function copyText(text) {
      navigator.clipboard.writeText(text);
      showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    }

    function saveHistory(text) {
      const data = JSON.parse(localStorage.getItem('qrHistory') || '[]');
      if (!data.includes(text)) {
        data.unshift(text);
        localStorage.setItem('qrHistory', JSON.stringify(data.slice(0, 50)));
      }
    }

    function renderHistory() {
      const data = JSON.parse(localStorage.getItem('qrHistory') || '[]');
      historyList.innerHTML = data.map(t => {
        const safeT = escapeHtml(t);
        const isLink = /^https?:\/\//i.test(t);
        let title = safeT;
        if (isLink) {
          try {
            const url = new URL(t);
            title = decodeURIComponent(url.pathname.split('/').filter(Boolean).pop() || url.hostname);
          } catch {}
        }
        return `
          <div class="item">
            <div class="title">${title}</div>
            <div class="content">${safeT}</div>
            <div class="buttons">
              <button onclick="copyText(\`${safeT}\`)">å¤åˆ¶</button>
              ${isLink ? `<button onclick="window.open(encodeURI('${t}'),'_blank')">æ‰“å¼€</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // æ¸…é™¤å†å²è®°å½•ï¼ˆç”¨æˆ·ç¡®è®¤ååˆ é™¤ localStorage ä¸­çš„ qrHistory å¹¶é‡ç»˜ï¼‰
    function clearHistory() {
      const data = JSON.parse(localStorage.getItem('qrHistory') || '[]');
      if (!data.length) {
        showToast('å½“å‰æ²¡æœ‰å†å²å¯æ¸…é™¤');
        return;
      }
      if (!confirm('ç¡®è®¤è¦æ¸…é™¤å…¨éƒ¨å†å²è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
      localStorage.removeItem('qrHistory');
      renderHistory();
      showToast('å†å²å·²æ¸…é™¤');
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;',
        '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    renderHistory();
  </script>
</body>
</html>
